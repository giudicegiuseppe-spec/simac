<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | SIMAC</title>
    <link rel="icon" href="logo.png">
    <link rel="stylesheet" href="/preventivatore/assets/share/css/materialize.min.css">
    <link rel="stylesheet" href="/preventivatore/mirror/custom.css">
  </head>
  <body style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:#f5f6f8;">
    <div class="card" style="width:100%;max-width:420px;border-radius:12px;">
      <div class="card-content">
        <div style="text-align:center;margin-bottom:16px;">
          <img src="/logo.png" alt="SIMAC" style="height:48px;">
        </div>
        <span class="card-title" style="display:block;text-align:center;">Accesso Agente</span>
        <div class="row" style="margin-top:12px;">
          <form id="login_form" class="col s12" onsubmit="return false;">
            <div class="input-field col s12">
              <input id="login_email" type="email" required>
              <label for="login_email">Email</label>
            </div>
            <div class="input-field col s12">
              <input id="login_password" type="password" required>
              <label for="login_password">Password</label>
            </div>
            <div class="col s12" style="text-align:right;">
              <button id="do_login" class="btn" type="submit">Entra</button>
            </div>
          </form>
          <div id="login_diag" style="margin-top:8px;font-size:12px;color:#607d8b;display:none;"></div>
        </div>
      </div>
    </div>
    <script src="/preventivatore/assets/share/js/materialize.min.js"></script>
    <script src="/preventivatore/assets/app/auth.js"></script>
    <script>
      (function(){
        if(window.Auth) return;
        var KEY='simac_session_v1';
        function setSession(sess){ try{ localStorage.setItem(KEY, JSON.stringify(sess||{})); }catch(_){ } }
        function getSession(){ try{ return JSON.parse(localStorage.getItem(KEY)||'{}'); }catch(_){ return {}; } }
        function clear(){ try{ localStorage.removeItem(KEY); }catch(_){ } }
        function isLogged(){ var s=getSession(); return !!(s && (s.email||s.agente_id)); }
        function requireAuth(){ if(!isLogged()){ try{ window.location.href='/preventivatore/mirror/'; }catch(_){ } return false; } return true; }
        function normalizeEmail(e){ return String(e||'').trim().toLowerCase(); }
        function detectDelim(sample){ var semi=(sample.match(/;/g)||[]).length; var comma=(sample.match(/,/g)||[]).length; var tab=(sample.match(/\t/g)||[]).length; if(tab>=semi && tab>=comma) return '\t'; return semi>comma?';':','; }
        function splitLine(line, d){ var res=[], cur='', inq=false; for(var i=0;i<line.length;i++){ var c=line[i]; if(c==='"'){ inq=!inq; } else if(c===d && !inq){ res.push(cur); cur=''; } else { cur+=c; } } res.push(cur); return res; }
        function clean(v){ return String(v==null?'':v).replace(/^\uFEFF/,'').replace(/^\s+|\s+$/g,''); }
        function parseCSV(txt){ try{ txt=String(txt||'').replace(/\uFEFF/g,'').replace(/\r\n/g,'\n').replace(/\r/g,'\n'); var lines=txt.split('\n').filter(function(l){ return l!=null && l!==''; }); if(!lines.length) return []; var d=detectDelim(lines[0]); var rows=lines.map(function(l){ return splitLine(l,d); }); var start=0; var hdr=rows[0].map(function(h){ return clean(h).toLowerCase(); }); if(hdr.join(',').indexOf('ruolo')>-1||hdr.join(',').indexOf('mail')>-1){ start=1; } var out=[]; for(var i=start;i<rows.length;i++){ var r=rows[i]; if(!r||r.length<2) continue; var ruolo=clean(r[0]); var mail=clean(r[1]); var pass=clean(r[2]); var nome=clean(r[3]); var am=clean(r[4]); if(!mail) continue; out.push({ email: normalizeEmail(mail), password: pass, agente:nome, area_manager:am, ruolo:ruolo }); } return out; }catch(_){ return []; } }
        async function tryLoad(url){ try{ var r=await fetch(url, {cache:'no-cache'}); if(!r.ok) return []; var t=await r.text(); return parseCSV(t); }catch(_){ return []; } }
        async function loadUsers(){ var cands=['user.csv','../user.csv','/preventivatore/user.csv','/preventivatore/mirror/user.csv']; for(var i=0;i<cands.length;i++){ var arr=await tryLoad(cands[i]); if(arr.length) return arr; } return []; }
        async function login(email, password){ var arr=await loadUsers(); var em=normalizeEmail(email); var u=arr.find(function(x){ return x.email===em && String(x.password||'').trim()===String(password||'').trim(); }); if(!u) throw new Error('Credenziali non valide'); var sess={ email: em, agente_id: em, agente: u.agente||em, area_manager: u.area_manager||'', ruolo: String(u.ruolo||'').toLowerCase() }; setSession(sess); return sess; }
        function logout(){ clear(); try{ window.location.href='/preventivatore/mirror/'; }catch(_){ } }
        window.Auth = { setSession:setSession, get:getSession, clear:clear, isLogged:isLogged, require:requireAuth, login:login, logout:logout };
      })();
    </script>
    <script>
      (function(){
        function go(){ try{ window.location.href = '/preventivatore/mirror/fv/contratto-fotovoltaico.html'; }catch(_){ } }
        // Forza nuova autenticazione: pulisce eventuali sessioni pregresse
        try{ if(window.Auth && Auth.clear){ Auth.clear(); } }catch(_){ }
        var diagEl = document.getElementById('login_diag');
        async function ensureAuth(){
          if(window.Auth) return true;
          var urls = [
            '/preventivatore/assets/app/auth.js',
            '/preventivatore/mirror/assets/app/auth.js',
            './assets/app/auth.js'
          ];
          for(var i=0;i<urls.length;i++){
            try{
              await new Promise(function(res, rej){
                var s=document.createElement('script'); s.src=urls[i]+'?t='+(Date.now()); s.async=true; s.onload=function(){ res(); }; s.onerror=function(){ rej(new Error('load failed')); };
                document.head.appendChild(s);
              });
              if(window.Auth) return true;
            }catch(e){}
          }
          return !!window.Auth;
        }
        async function updateDiag(){
          await ensureAuth();
          try{
            if(window.Auth && Auth.usersInfo){
              var info = await Auth.usersInfo();
              diagEl.style.display='block';
              diagEl.textContent = 'Utenti caricati: '+info.count+(info.emails && info.emails.length? '  Esempi: '+info.emails.join(', ') : '')+(info.url? ' (da '+info.url+')':'' );
              return;
            }
          }catch(_){ }
          // Fallback se Auth non disponibile
          try{ diagEl.style.display='block'; diagEl.textContent='Auth non disponibile.'; }catch(_){ }
        }

        updateDiag();
        document.getElementById('login_form').addEventListener('submit', async function(e){
          e.preventDefault();
          var email = (document.getElementById('login_email').value||'').trim();
          var pass  = (document.getElementById('login_password').value||'').trim();
          if(diagEl && email){ diagEl.style.display='block'; diagEl.textContent = 'Utenti caricati... prova login per '+email.toLowerCase(); }
          if(!email || !pass){ M && M.toast && M.toast({html:'Inserisci email e password'}); return; }
          try{
            if(!(window.Auth && typeof Auth.login==='function')){ throw new Error('Login fallito'); }
            await Auth.login(email, pass);
            go();
          }catch(err){
            var msg='Login fallito';
            if(window.M && M.toast){ M.toast({html: msg}); } else { alert(msg); }
          }
        });
      })();
    </script>
  </body>
</html>